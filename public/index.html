<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Table_Link</title>
  <style>
    /* ============================================================
       TABLE_LINK UI ‚Äî Retro 90s tabletop vibe (iframe responsive)
       ============================================================ */

    :root{
      --bg0:#05070c;
      --bg1:#0b1020;
      --panel:#121a2f;
      --panel2:#0f162a;
      --ink:#e6ecff;
      --muted:#9fb1ff;
      --acid:#00ffd5;
      --hot:#ff3c8f;
      --warn:#ffb020;
      --ok:#2ee59d;
      --bad:#ff4d4f;
      --line:rgba(255,255,255,.14);
      --shadow: 0 14px 34px rgba(0,0,0,.55);
      --radius: 16px;
      --radius2: 12px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    html, body{
      height:100%; width:100%; margin:0; padding:0;
      background: transparent !important; color: var(--ink);
      overflow:hidden; font-family: var(--sans);
    }
    body:before, body:after{ content:none !important; display:none !important; }

    /* Utility */
    .hidden { display:none !important; }
    .mono { font-family: var(--mono); }
    .dim { opacity:.8; }
    .small { font-size:12px; }

    /* App shell */
    #app{ height:100%; width:100%; display:flex; align-items:flex-start; justify-content:center; padding:15px; box-sizing:border-box; }

    .frame{
      width: 100%; height: 100%; display:flex; flex-direction:column;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
        radial-gradient(900px 500px at 15% 0%, rgba(255,60,143,.18), rgba(0,0,0,0)),
        radial-gradient(900px 500px at 85% 0%, rgba(0,255,213,.12), rgba(0,0,0,0)), var(--panel2);
      border: 1px solid rgba(255,255,255,.12); box-shadow: var(--shadow); overflow:hidden;
    }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10); background: linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.05)); }
    .brand{ display:flex; align-items:baseline; gap:10px; font-weight:800; letter-spacing:.6px; text-transform:uppercase; }
    .brand .logo{ font-size:14px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.28); box-shadow: inset 0 0 0 1px rgba(0,255,213,.08); }
    .statuschip{ display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.22); font-size:12px; color: var(--muted); }
    .dot{ width:8px;height:8px;border-radius:50%; background: rgba(255,255,255,.20); }
    .dot.on{ background: var(--ok); box-shadow: 0 0 12px rgba(46,229,157,.55); }

    .main{ flex:1; display:flex; overflow:hidden; min-height:0; }
    .panel{ flex:1; padding:14px; overflow:auto; box-sizing:border-box; }

    .card{ border-radius: var(--radius); border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), rgba(0,0,0,.18); box-shadow: inset 0 0 0 1px rgba(0,255,213,.05); padding:14px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 860px){ .grid2{ grid-template-columns: 1fr; } }

    h1,h2,h3{ margin:0 0 10px 0; font-weight:800; letter-spacing:.2px; }
    h2{ font-size:18px; } h3{ font-size:14px; color: var(--muted); text-transform: uppercase; letter-spacing:.7px; }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0; font-size:13px; }
    .field{ display:flex; flex-direction:column; gap:6px; margin:10px 0; }
    label{ font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing:.6px; }
    input, select{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.25); color: var(--ink); outline:none; font-size:14px; }

    .btnrow{ display:flex; gap:10px; flex-wrap:wrap; }
    button, a.btn{ appearance:none; border:none; cursor:pointer; user-select:none; border-radius: 12px; padding:11px 12px; font-size:14px; font-weight:800; letter-spacing:.2px; color: var(--ink); background: rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); box-shadow: 0 8px 18px rgba(0,0,0,.35); transition: transform .06s ease, filter .12s ease; text-decoration:none; display:inline-flex; align-items:center; justify-content:center; gap:8px; min-width: 160px; flex: 1; }
    button:active, a.btn:active{ transform: translateY(1px); }
    button:hover, a.btn:hover{ filter: brightness(1.08); }

    .primary{ background: linear-gradient(180deg, rgba(0,255,213,.24), rgba(0,255,213,.08)); border-color: rgba(0,255,213,.35); box-shadow: 0 0 0 1px rgba(0,255,213,.12) inset, 0 10px 22px rgba(0,0,0,.40); }
    .hot{ background: linear-gradient(180deg, rgba(255,60,143,.26), rgba(255,60,143,.08)); border-color: rgba(255,60,143,.40); }
    .warn{ background: linear-gradient(180deg, rgba(255,176,32,.26), rgba(255,176,32,.08)); border-color: rgba(255,176,32,.42); }
    .ok{ background: linear-gradient(180deg, rgba(46,229,157,.24), rgba(46,229,157,.08)); border-color: rgba(46,229,157,.38); }
    .bad{ background: linear-gradient(180deg, rgba(255,77,79,.26), rgba(255,77,79,.08)); border-color: rgba(255,77,79,.42); }

    .toolbar{ display:flex; gap:10px; flex-wrap:wrap; }
    .toolbar button, .toolbar a.btn{ min-width: 150px; flex: 1; }
    .split{ display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; align-items:start; }
    @media (max-width: 860px){ .split{ grid-template-columns: 1fr; } }

    ul{ list-style:none; padding:0; margin:0; }
    li{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 10px; border-radius: 12px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); margin-bottom:8px; }

    /* Video area */
    #videoContainer{ position:relative; width:100%; border-radius: var(--radius2); overflow:hidden; background:#000; border:1px solid rgba(255,255,255,.12); box-shadow: inset 0 0 0 1px rgba(0,255,213,.08); min-height: 180px; }
    #videoPreview{ width:100%; display:block; }
    #cropOverlay{ position:absolute; inset:0; pointer-events:none; display:none; border:2px solid rgba(255,255,255,.4); box-shadow: inset 0 0 0 0 rgba(0,0,0,0.5); }

    /* Panels */
    .drawer{ margin-top:12px; border-radius: var(--radius); border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.18); padding:12px; display:none; }
    .drawer.active{ display:block; }
    .hint{ font-size:12px; color: rgba(230,236,255,.70); background: rgba(0,255,213,.08); border:1px solid rgba(0,255,213,.18); padding:10px 10px; border-radius: 12px; line-height:1.35; }

    /* Dice */
    .dice-btn-row{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .dice-btn-row button{ min-width: 60px; }
    .die-box{ display:flex; align-items:center; justify-content:center; font-weight:900; border-radius: 10px; border:2px solid rgba(255,255,255,.35); box-shadow: 0 8px 18px rgba(0,0,0,.35); }
    .dice-area{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; min-height: 44px; }
    .type-D3  { background: #f0ad4e; color: #000; } .type-D6  { background: #333; } .type-D10 { background: #0275d8; } .type-D20 { background: #d9534f; }
    .size-S { width: 34px; height: 34px; font-size: 14px; } .size-M { width: 54px; height: 54px; font-size: 22px; } .size-L { width: 84px; height: 84px; font-size: 36px; }

    /* Toggles & Sliders */
    .toggleBtn{ width:auto; padding:8px 10px; border-radius:999px; background: rgba(0,255,213,.22); border:1px solid rgba(0,255,213,.35); color: var(--ink); font-weight:900; min-width: 72px; flex: 0 0 auto; }
    .toggleBtn.off{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.14); color: rgba(230,236,255,.75); }
    
    input[type=range] { padding:0; background:transparent; border:none; height:20px; }
    .slider-val { width:45px; text-align:right; font-family:var(--mono); color:var(--acid); }

    #sendStatus{ display:none; margin-top:10px; font-size:12px; color: var(--muted); white-space: pre-line; border-left: 3px solid rgba(0,255,213,.5); padding-left:10px; }

    /* ============================================================
       PROJECTOR MODE
       ============================================================ */
    #projectorView { display:none; position: fixed; inset: 0; width: 100%; height: 100%; background: black; z-index: 9999; align-items: center; justify-content: center; }
    #projectorContent { position: relative; width: 1500px; height: 1100px; display: flex; justify-content: center; align-items: center; }
    
    /* NEW: Transform attributes allow panning, zooming, twisting */
    #projectorImage { 
        display:block; width:100%; height:100%; object-fit: fill; z-index: 1; 
        transition: transform 0.1s ease-out; transform-origin: center center;
    }
    
    #projectorGridCanvas { position:absolute; top:0; left:0; width:100%; height:100%; z-index:2; pointer-events:none; display:none; }
    #projectorDiceOverlay { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 20px; border-radius: 15px; z-index: 10002; display: none; pointer-events: none; border: 2px solid white; }
    #projectorDebug { color: #00ff00; font-family: var(--mono); font-size: 14px; position: absolute; top: 10px; left: 10px; z-index: 10001; background: rgba(0,0,0,0.5); padding: 10px; pointer-events: none; white-space: pre-line; }
    #fullscreenHint { color: rgba(255,255,255,0.5); font-size: 12px; position: absolute; bottom: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 10001; }
    #projectorBlank { display: none; position: fixed; inset: 0; background: black; z-index: 10000; }
  </style>
</head>

<body>
  <div id="projectorView" ondblclick="toggleFullScreen()">
    <div id="projectorDebug">Initializing...</div>
    <div id="projectorContent">
      <img id="projectorImage" src="">
      <canvas id="projectorGridCanvas"></canvas>
    </div>
    <div id="projectorDiceOverlay">
      <div style="color:white; font-size:12px; margin-bottom:5px;">INCOMING ROLL:</div>
      <div id="projDiceContainer" class="dice-area" style="margin-top:0;"></div>
    </div>
    <div id="fullscreenHint">(Double-click screen for true fullscreen)</div>
  </div>
  <div id="projectorBlank"></div>

  <div id="app">
    <div class="frame" id="mainInterface">

      <div class="topbar">
        <div class="brand">
          <div class="logo mono">TL</div>
          <div class="title">Table_Link</div>
        </div>
        <div class="statuschip" title="Status">
          <span class="dot" id="statusDot"></span>
          <span id="statusText" class="mono">BOOT: ready</span>
        </div>
      </div>

      <div class="main">
        <div class="panel">

          <div id="screenStart" class="card">
            <h2>Enter the Hub</h2>
            <div class="field">
              <label>Player ID</label>
              <input id="playerIdInput" type="text" placeholder="Your unique Player ID" />
            </div>
            <div class="btnrow" style="margin-top:12px;">
              <button class="primary" onclick="uiStart()">‚ñ∂ Start</button>
            </div>
          </div>

          <div id="screenMode" class="card hidden">
            <h2>Choose Your Path</h2>
            <div class="grid2" style="margin-top:10px;">
              <div class="card" style="padding:12px;">
                <h3>Host</h3>
                <div class="field">
                  <label>Room Name</label>
                  <input id="gameName" type="text" placeholder="e.g., Friday Night Skirmish" />
                </div>
                <button class="primary" onclick="hostGame()">üúÅ Host</button>
              </div>
              <div class="card" style="padding:12px;">
                <h3>Join</h3>
                <div class="small dim" style="margin-bottom:10px;">Available rooms:</div>
                <ul id="gameList"><li>Searching...</li></ul>
              </div>
            </div>
            <div class="btnrow" style="margin-top:12px;">
              <button onclick="uiBackToStart()">‚Üê Back</button>
            </div>
          </div>

          <div id="screenRoom" class="card hidden">
            <div class="row" style="margin-top:0;">
              <div>
                <h2 id="roomTitle" style="margin-bottom:4px;">Room</h2>
                <div class="mono small dim">ROOM: <b id="roomCode">.....</b></div>
              </div>
              <button class="bad" style="min-width:140px; flex:0 0 auto;" onclick="leaveGame()">‚üµ Exit</button>
            </div>

            <div class="toolbar" style="margin-top:10px;">
              <a id="projectorLink" class="btn hot" href="#" target="_blank">‚õ∂ Projector</a>
              <button class="ok" onclick="startCamera()">üì∑ Camera</button>
              <button class="warn" onclick="toggleDrawer('settingsDrawer')">‚öô Settings</button>
              <button onclick="toggleDrawer('diceDrawer')">üé≤ Dice</button>
              <button class="primary" onclick="toggleDrawer('alignDrawer')">üéõÔ∏è Align Map</button>
            </div>

            <div class="split" style="margin-top:12px;">
              <div class="card" style="padding:12px;">
                <h3>Camera Preview</h3>
                <div id="videoContainer" style="margin-top:10px;">
                  <video id="videoPreview" autoplay playsinline></video>
                  <div id="cropOverlay"></div>
                </div>
                <div class="btnrow" style="margin-top:10px;">
                  <button id="startBtn" class="primary hidden" onclick="startSending()">‚ñ∂ Start Auto-Send</button>
                  <button id="stopBtn" class="bad hidden" onclick="stopSending()">‚ñ† Stop Sending</button>
                </div>
                <div id="sendStatus"></div>
                <canvas id="canvas" style="display:none;"></canvas>
              </div>

              <div class="card" style="padding:12px;">
                <h3>Players</h3>
                <ul id="playerList"></ul>
              </div>
            </div>

            <div id="settingsDrawer" class="drawer">
              <h3>Settings / Calibration</h3>
              
              <div class="row">
                <div><div style="font-weight:800;">Calibration Mode</div><div class="small dim">Projector shows your feed</div></div>
                <button id="calibBtn" class="toggleBtn off" onclick="toggleCalibrationMode()">OFF</button>
              </div>

              <div class="row">
                <div><div style="font-weight:800;">Grid Overlay</div><div class="small dim">22 rows √ó 30 cols</div></div>
                <button id="gridToggleBtn" class="toggleBtn off" onclick="toggleGrid()">OFF</button>
              </div>

              <div class="grid2">
                <div class="field">
                  <label>Square Width (px)</label>
                  <input id="gridWidthInput" type="number" min="10" max="400" value="50" oninput="onGridInput()" />
                </div>
                <div class="field">
                  <label>Square Height (px)</label>
                  <input id="gridHeightInput" type="number" min="10" max="400" value="50" oninput="onGridInput()" />
                </div>
              </div>
              
              <hr style="border:none; border-top:1px solid rgba(255,255,255,.10); margin:12px 0;">

              <h3>Crop Camera (%)</h3>
              <div class="row">
                  <label>Top</label><input type="range" id="cropTop" min="0" max="45" value="0" oninput="updateCrop()">
              </div>
              <div class="row">
                  <label>Bottom</label><input type="range" id="cropBottom" min="0" max="45" value="0" oninput="updateCrop()">
              </div>
              <div class="row">
                  <label>Left</label><input type="range" id="cropLeft" min="0" max="45" value="0" oninput="updateCrop()">
              </div>
              <div class="row">
                  <label>Right</label><input type="range" id="cropRight" min="0" max="45" value="0" oninput="updateCrop()">
              </div>
            </div>

            <div id="diceDrawer" class="drawer">
              <h3>Dice Tray</h3>
              <div class="grid2">
                <div class="field">
                  <label>Quantity</label>
                  <input type="number" id="diceQty" value="1" min="1" max="20">
                </div>
                <div class="field">
                  <label>Display Size</label>
                  <select id="diceSize">
                    <option value="size-S">Small</option>
                    <option value="size-M" selected>Medium</option>
                    <option value="size-L">Large</option>
                  </select>
                </div>
              </div>
              <div class="dice-btn-row">
                <button class="btn-d3" onclick="rollDice(3, 'D3')">D3</button>
                <button class="btn-d6" onclick="rollDice(6, 'D6')">D6</button>
                <button class="btn-d10" onclick="rollDice(10, 'D10')">D10</button>
                <button class="btn-d20" onclick="rollDice(20, 'D20')">D20</button>
              </div>
              <div id="localDiceResults" class="dice-area"></div>
            </div>

            <div id="alignDrawer" class="drawer">
              <h3>Align Opponent's Map</h3>
              <div class="hint" style="margin-bottom:12px;">
                Use these to lock the incoming map to your physical table grid. It affects the incoming image, not your grid lines.
              </div>
              <div class="row">
                <label>Pan X</label> 
                <input type="range" id="alignX" min="-1500" max="1500" value="0" oninput="updateAlign()">
                <div class="slider-val" id="valX">0</div>
              </div>
              <div class="row">
                <label>Pan Y</label> 
                <input type="range" id="alignY" min="-1500" max="1500" value="0" oninput="updateAlign()">
                <div class="slider-val" id="valY">0</div>
              </div>
              <div class="row">
                <label>Zoom</label> 
                <input type="range" id="alignZ" min="10" max="300" value="100" oninput="updateAlign()">
                <div class="slider-val" id="valZ">1.0x</div>
              </div>
              <div class="row">
                <label>Twist</label> 
                <input type="range" id="alignR" min="-180" max="180" value="0" oninput="updateAlign()">
                <div class="slider-val" id="valR">0¬∞</div>
              </div>
              <button class="bad" style="margin-top:10px" onclick="resetAlign()">Reset Alignment</button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoomId = null;
    let cameraStream = null;
    let sendIntervalId = null;
    let myPlayerId = null;

    let isProjectorMode = false;
    let projectorOwnerId = null;
    let projectorRoomId = null;
    
    let calibrationMode = false;
    let projectorViewMode = 'normal';

    const SEND_EVERY_MS = 30000;
    
    // Grid Settings
    let gridEnabled = false;
    let gridW = 50; let gridH = 50;
    let projGridEnabled = false;
    let projGridW = 50; let projGridH = 50;
    
    let crop = { t: 0, b: 0, l: 0, r: 0 };
    let alignState = { x: 0, y: 0, z: 100, r: 0 };

    const GRID_COLS = 30; 
    const GRID_ROWS = 22;

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');

      if (mode === 'projector') {
        isProjectorMode = true;
        projectorRoomId = params.get('room');
        projectorOwnerId = params.get('owner');

        document.getElementById('mainInterface').classList.add('hidden');
        document.getElementById('projectorView').style.display = 'flex';
        updateDebug(`Projector Active\nOwner: ${projectorOwnerId}\nMode: normal`);
        
        updateProjectorLayout();
        if (projectorRoomId && projectorOwnerId) {
          socket.emit('joinAsProjector', { roomId: projectorRoomId, ownerId: projectorOwnerId });
        }
        return;
      }
      loadPrefs();
      syncUI();
    };

    // --- DRAWER LOGIC ---
    function toggleDrawer(id) {
        ['settingsDrawer', 'diceDrawer', 'alignDrawer'].forEach(d => {
            if (d !== id) document.getElementById(d).classList.remove('active');
        });
        document.getElementById(id).classList.toggle('active');
        
        // Show crop overlay if settings opened, hide otherwise
        document.getElementById('cropOverlay').style.display = (id === 'settingsDrawer') ? 'block' : 'none';
        updateCropOverlay();
    }

    // --- BASIC UI FLOW ---
    function uiStart(){
      const el = document.getElementById('playerIdInput');
      myPlayerId = el.value.trim();
      if(!myPlayerId){ alert("Enter an ID"); return; }
      document.getElementById('screenStart').classList.add('hidden');
      document.getElementById('screenMode').classList.remove('hidden');
      setAppStatus("mode_select", "ok");
    }
    function uiBackToStart(){
      document.getElementById('screenMode').classList.add('hidden');
      document.getElementById('screenStart').classList.remove('hidden');
      setAppStatus("boot: ready", "dim");
    }
    function setAppStatus(text, stateClass){
      const t = document.getElementById('statusText');
      const d = document.getElementById('statusDot');
      t.innerText = text.toUpperCase();
      d.className = "dot";
      if(stateClass === "ok") d.classList.add("on");
    }

    // --- ALIGNMENT LOGIC ---
    function updateAlign() {
        alignState.x = parseInt(document.getElementById('alignX').value);
        alignState.y = parseInt(document.getElementById('alignY').value);
        alignState.z = parseInt(document.getElementById('alignZ').value);
        alignState.r = parseInt(document.getElementById('alignR').value);
        
        document.getElementById('valX').innerText = alignState.x;
        document.getElementById('valY').innerText = alignState.y;
        document.getElementById('valZ').innerText = (alignState.z / 100).toFixed(1) + 'x';
        document.getElementById('valR').innerText = alignState.r + '¬∞';
        
        savePrefs();
        sendAlignUpdate();
    }
    function resetAlign() {
        document.getElementById('alignX').value = 0;
        document.getElementById('alignY').value = 0;
        document.getElementById('alignZ').value = 100;
        document.getElementById('alignR').value = 0;
        updateAlign();
    }
    function sendAlignUpdate() {
        if (!currentRoomId) return;
        socket.emit('setReceiverTransform', {
            roomId: currentRoomId,
            ownerId: myPlayerId,
            transform: { x: alignState.x, y: alignState.y, scale: alignState.z / 100, rotate: alignState.r }
        });
    }

    // --- CROP LOGIC ---
    function updateCrop() {
        crop.t = parseInt(document.getElementById('cropTop').value);
        crop.b = parseInt(document.getElementById('cropBottom').value);
        crop.l = parseInt(document.getElementById('cropLeft').value);
        crop.r = parseInt(document.getElementById('cropRight').value);
        updateCropOverlay();
    }
    function updateCropOverlay() {
        const o = document.getElementById('cropOverlay');
        o.style.top = crop.t + "%"; o.style.bottom = crop.b + "%";
        o.style.left = crop.l + "%"; o.style.right = crop.r + "%";
        o.style.outline = "1000px solid rgba(0,0,0,0.6)";
    }

    // --- DICE LOGIC ---
    function rollDice(sides, typeName) {
        if (!currentRoomId) return alert("Join a room first!");
        const qty = parseInt(document.getElementById('diceQty').value);
        const size = document.getElementById('diceSize').value;
        const results = [];
        for(let i=0; i<qty; i++) results.push(Math.floor(Math.random() * sides) + 1);
        const diceData = { results, size, type: typeName };
        renderDice(diceData, 'localDiceResults');
        socket.emit('rollDice', { roomId: currentRoomId, dice: diceData, senderId: myPlayerId });
    }
    function renderDice(diceData, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = ''; 
        diceData.results.forEach(num => {
            const die = document.createElement('div');
            die.className = `die-box type-${diceData.type} ${diceData.size}`;
            die.innerText = num;
            container.appendChild(die);
        });
    }

    // --- UTILS & PREFS ---
    function loadPrefs() { 
        gridEnabled = (localStorage.getItem("wg_grid_en")==="true"); 
        gridW = parseInt(localStorage.getItem("wg_grid_w")||"50"); 
        gridH = parseInt(localStorage.getItem("wg_grid_h")||"50"); 
        
        alignState.x = parseInt(localStorage.getItem("wg_aln_x")||"0");
        alignState.y = parseInt(localStorage.getItem("wg_aln_y")||"0");
        alignState.z = parseInt(localStorage.getItem("wg_aln_z")||"100");
        alignState.r = parseInt(localStorage.getItem("wg_aln_r")||"0");
    }
    function savePrefs() {
        localStorage.setItem("wg_grid_en", gridEnabled); 
        localStorage.setItem("wg_grid_w", gridW); localStorage.setItem("wg_grid_h", gridH);
        localStorage.setItem("wg_aln_x", alignState.x); localStorage.setItem("wg_aln_y", alignState.y);
        localStorage.setItem("wg_aln_z", alignState.z); localStorage.setItem("wg_aln_r", alignState.r);
    }
    function syncUI() {
      document.getElementById('gridToggleBtn').classList.toggle('off', !gridEnabled);
      document.getElementById('gridToggleBtn').innerText = gridEnabled ? "ON" : "OFF";
      document.getElementById('gridWidthInput').value = gridW;
      document.getElementById('gridHeightInput').value = gridH;
      
      document.getElementById('alignX').value = alignState.x;
      document.getElementById('alignY').value = alignState.y;
      document.getElementById('alignZ').value = alignState.z;
      document.getElementById('alignR').value = alignState.r;
      updateAlign();
    }
    function updateProjectorLink() {
      if (!currentRoomId || !myPlayerId) return;
      document.getElementById('projectorLink').href = `${window.location.origin}/?mode=projector&room=${encodeURIComponent(currentRoomId)}&owner=${encodeURIComponent(myPlayerId)}`;
    }
    function updateDebug(msg) { const el = document.getElementById('projectorDebug'); if(el) el.innerText = msg; }
    function setGameStatus(msg) { const el = document.getElementById('sendStatus'); el.style.display = msg?'block':'none'; el.innerText=msg||''; }
    function toggleFullScreen() {
      const d=document, e=d.documentElement;
      (d.fullscreenElement?d.exitFullscreen:e.requestFullscreen).call(d.fullscreenElement?d:e);
    }

    // --- GRID CONTROLS ---
    function sendGridUpdate() { 
        if(currentRoomId) socket.emit('setProjectorGrid', { roomId: currentRoomId, ownerId: myPlayerId, enabled: !!gridEnabled, width: gridW, height: gridH }); 
    }
    function toggleCalibrationMode() {
      calibrationMode = !calibrationMode;
      const b = document.getElementById('calibBtn');
      if (calibrationMode) {
        b.classList.add('on'); b.innerText = "ON";
        setGameStatus("Calibration ON: Projector shows YOUR camera feed.");
        if(currentRoomId) socket.emit('setProjectorViewMode', { roomId: currentRoomId, ownerId: myPlayerId, mode: 'calibrate' });
        sendGridUpdate();
      } else {
        b.classList.remove('on'); b.innerText = "OFF";
        setGameStatus("Calibration OFF: Projector shows opponent.");
        if(currentRoomId) socket.emit('setProjectorViewMode', { roomId: currentRoomId, ownerId: myPlayerId, mode: 'normal' });
        socket.emit('setProjectorGrid', { roomId: currentRoomId, ownerId: myPlayerId, enabled: false, width: gridW, height: gridH });
      }
    }
    function toggleGrid() { gridEnabled = !gridEnabled; syncUI(); savePrefs(); if(calibrationMode) sendGridUpdate(); }
    function onGridInput() { 
        const w = parseInt(document.getElementById('gridWidthInput').value);
        const h = parseInt(document.getElementById('gridHeightInput').value);
        if(w) gridW = Math.max(10, Math.min(400, w));
        if(h) gridH = Math.max(10, Math.min(400, h));
        savePrefs(); if(calibrationMode) sendGridUpdate(); 
    }

    // --- CAMERA & SENDING ---
    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(s => {
        cameraStream = s;
        const v = document.getElementById('videoPreview'); v.srcObject = s; v.style.display = 'block';
        document.getElementById('startBtn').classList.remove('hidden');
        document.getElementById('cropOverlay').style.display = 'block';
      }).catch(() => alert("Camera blocked!"));
    }
    function drawCenterDot(ctx, w, h) {
      const cx = w/2, cy = h/2;
      ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.strokeStyle="rgba(255,255,255,0.8)"; ctx.lineWidth=3; ctx.stroke();
      ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fillStyle="rgba(255,0,0,1)"; ctx.fill();
    }
    function captureAndSendFrame() {
      if (!cameraStream || !currentRoomId) return;
      const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d'), video = document.getElementById('videoPreview');
      canvas.width = 1280; canvas.height = 720;
      const vidW = video.videoWidth, vidH = video.videoHeight;
      if (!vidW || !vidH) return; 
      const sx = (crop.l/100)*vidW, sy = (crop.t/100)*vidH;
      const sWidth = vidW - ((crop.l+crop.r)/100)*vidW, sHeight = vidH - ((crop.t+crop.b)/100)*vidH;
      ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
      if (calibrationMode) drawCenterDot(ctx, canvas.width, canvas.height);
      socket.emit('sendImage', { roomId: currentRoomId, image: canvas.toDataURL('image/jpeg', 0.6) });
      setGameStatus(`Sent snapshot at ${new Date().toLocaleTimeString()}`);
    }
    function startSending() {
      if (!cameraStream || !currentRoomId) return alert("Setup first!");
      if (sendIntervalId) return;
      setGameStatus("Starting...");
      captureAndSendFrame();
      sendIntervalId = setInterval(captureAndSendFrame, SEND_EVERY_MS);
      document.getElementById('startBtn').classList.add('hidden');
      document.getElementById('stopBtn').classList.remove('hidden');
    }
    function stopSending() {
      if (sendIntervalId) clearInterval(sendIntervalId);
      sendIntervalId = null;
      document.getElementById('stopBtn').classList.add('hidden');
      document.getElementById('startBtn').classList.remove('hidden');
      setGameStatus("Stopped.");
    }

    // --- PROJECTOR RENDER LOGIC ---
    function updateProjectorLayout() {
        if (!isProjectorMode) return;
        const targetW = GRID_COLS * projGridW;
        const targetH = GRID_ROWS * projGridH;
        
        const container = document.getElementById('projectorContent');
        container.style.width = targetW + 'px';
        container.style.height = targetH + 'px';
        
        const c = document.getElementById('projectorGridCanvas');
        c.width = targetW; c.height = targetH;
        const ctx = c.getContext('2d');
        ctx.clearRect(0,0,targetW,targetH);
        
        if (!projGridEnabled) return;
        c.style.display='block';
        
        ctx.lineWidth=1; ctx.strokeStyle="white"; ctx.globalAlpha=0.6;
        for(let x=0; x<=GRID_COLS; x++) { ctx.beginPath(); ctx.moveTo(x*projGridW, 0); ctx.lineTo(x*projGridW, targetH); ctx.stroke(); }
        for(let y=0; y<=GRID_ROWS; y++) { ctx.beginPath(); ctx.moveTo(0, y*projGridH); ctx.lineTo(targetW, y*projGridH); ctx.stroke(); }
        ctx.lineWidth=2; ctx.strokeStyle="#00ff00"; ctx.globalAlpha=0.8;
        ctx.beginPath(); ctx.moveTo((GRID_COLS/2)*projGridW, 0); ctx.lineTo((GRID_COLS/2)*projGridW, targetH); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0, (GRID_ROWS/2)*projGridH); ctx.lineTo(targetW, (GRID_ROWS/2)*projGridH); ctx.stroke();
        ctx.globalAlpha=1;
    }

    // --- SOCKET HANDLERS ---
    socket.on('errorMsg', alert);
    socket.on('projectorBlank', ({blank}) => { if(isProjectorMode) document.getElementById('projectorBlank').style.display = blank?'block':'none'; });
    socket.on('projectorViewMode', ({mode}) => { if(isProjectorMode) { projectorViewMode=mode; updateDebug(`Projector Active\nOwner: ${projectorOwnerId}\nMode: ${mode}`); } });
    
    socket.on('projectorGrid', ({ownerId, enabled, width, height}) => { 
        if(isProjectorMode && ownerId === projectorOwnerId) { 
            projGridEnabled=enabled; projGridW = width||50; projGridH = height||50;
            updateProjectorLayout();
            document.getElementById('projectorGridCanvas').style.display = enabled?'block':'none'; 
        } 
    });
    
    // APPLY TRANSFORM TO IMAGE ONLY
    socket.on('receiverTransform', ({ownerId, transform}) => {
        if(isProjectorMode && ownerId === projectorOwnerId) {
            const img = document.getElementById('projectorImage');
            img.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale}) rotate(${transform.rotate}deg)`;
        }
    });
    
    socket.on('receiveImage', ({image, senderId}) => {
      if (!isProjectorMode) return;
      if (projectorViewMode === 'normal' && senderId === projectorOwnerId) return;
      if (projectorViewMode === 'calibrate' && senderId !== projectorOwnerId) return;
      document.getElementById('projectorImage').src = image;
      document.getElementById('fullscreenHint').style.display = 'none';
    });
    
    socket.on('diceRolled', ({ dice, senderId }) => {
        if (isProjectorMode) {
            const overlay = document.getElementById('projectorDiceOverlay');
            overlay.style.display = 'block';
            renderDice(dice, 'projDiceContainer');
            setTimeout(() => { overlay.style.display = 'none'; }, 8000);
        }
    });

    // --- HOST / JOIN LOGIC ---
    function hostGame() { const n = document.getElementById('gameName').value.trim(); if(n && myPlayerId) socket.emit('hostGame', {name:n, playerId:myPlayerId}); }
    function joinGame(id) { if(myPlayerId) socket.emit('joinGame', {roomId:id, playerId:myPlayerId}); }
    function leaveGame() { if(currentRoomId) socket.emit('leaveGame', currentRoomId); }
    
    socket.on('updateGameList', (g) => {
      const l = document.getElementById('gameList'); l.innerHTML = '';
      Object.values(g).forEach(r => l.innerHTML += `<li><b>${r.name}</b> <button class="primary" style="width:auto; padding:6px 12px; min-width:60px;" onclick="joinGame('${r.id}')">Join</button></li>`);
    });
    
    socket.on('joinedRoom', (r) => {
      currentRoomId = r.id;
      document.getElementById('screenMode').classList.add('hidden');
      document.getElementById('screenRoom').classList.remove('hidden');
      document.getElementById('roomTitle').innerText = r.name;
      document.getElementById('roomCode').innerText = r.id;
      document.getElementById('playerList').innerHTML = r.players.map(p => `<li><b>üë§ ${p}</b></li>`).join('');
      setAppStatus(`connected: ${r.name}`, "ok");
      
      updateProjectorLink();
      
      calibrationMode = false;
      document.getElementById('calibBtn').classList.remove('on');
      document.getElementById('calibBtn').innerText = 'OFF';
      setProjectorViewMode('normal');
      
      loadPrefs();
      syncUI();
      sendGridUpdate();
      sendAlignUpdate(); // Push saved transform to projector instantly
    });
    
    socket.on('playerUpdate', (p) => document.getElementById('playerList').innerHTML = p.map(u => `<li><b>üë§ ${u}</b></li>`).join(''));
    
    socket.on('backToLobby', () => {
      currentRoomId = null; stopSending();
      document.getElementById('screenRoom').classList.add('hidden');
      document.getElementById('screenMode').classList.remove('hidden');
      if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null;
      projGridEnabled=false;
      setAppStatus("mode_select", "ok");
    });
  </script>
</body>
</html>
