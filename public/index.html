<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Multiplayer Game</title>
  <style>
    body, html { margin: 0; padding: 0; font-family: sans-serif; height: 100%; width: 100%; background: black; overflow: hidden; }
    .hidden-section { display: none !important; }

    /* --- CONTROLLER UI --- */
    .screen { display: none; padding: 20px; flex-direction: column; align-items: center; height: 100%; overflow-y: auto; background: #f4f4f4; box-sizing: border-box; }
    .active { display: flex; }
    .card { background: white; width: 100%; max-width: 420px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #ddd; text-align: center; box-sizing: border-box; }

    button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
    .btn-primary { background: #0070f3; color: white; }
    .btn-camera { background: #28a745; color: white; }
    .btn-stop { background: #ff4d4f; color: white; font-weight: bold; display: none; }
    .btn-calib { background: #111; color: white; font-weight: bold; display: none; }
    .btn-calib.on { background: #ff0080; }

    .btn-link-projector { display: block; width: 100%; padding: 12px; margin-top: 15px; background: #111; color: white; text-decoration: none; border-radius: 8px; text-align: center; font-weight: bold; box-sizing: border-box; }

    /* Inputs */
    input { width: 90%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; }
    .row { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin: 10px 0; font-size: 13px; }
    .toggleBtn { width: auto; padding: 8px 10px; border-radius: 10px; background: #0070f3; color: white; font-weight: bold; margin-top: 0; }
    .toggleBtn.off { background: #ddd; color: #333; }
    
    /* Dual Input Wrap */
    .dual-input { display: flex; gap: 5px; align-items: center; }
    .dual-input input { width: 60px; text-align: center; font-weight: bold; margin: 0; }
    .label { font-size: 11px; color: #666; text-transform: uppercase; }

    ul { list-style: none; padding: 0; }
    li { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }

    #videoPreview { width: 100%; border-radius: 8px; background: #000; display: none; margin-top: 10px; }
    #sendStatus { display: none; font-size: 12px; opacity: 0.75; margin-top: 8px; color: #0070f3; white-space: pre-line; }

    /* --- PROJECTOR MODE --- */
    #projectorView { display: none; position: fixed; inset: 0; width: 100%; height: 100%; background: black; z-index: 9999; align-items: center; justify-content: center; }

    /* Keeping 'contain' as requested for now (Black bars might appear) */
    #projectorImage {
      display: block;
      max-width: 100vw;
      max-height: 100vh;
      width: auto;
      height: auto;
      object-fit: contain; 
      z-index: 1;
    }

    /* Grid overlay */
    #projectorGridCanvas { position: fixed; inset: 0; width: 100vw; height: 100vh; z-index: 9999; pointer-events: none; display: none; }

    #projectorDebug { color: #00ff00; font-family: monospace; font-size: 14px; position: absolute; top: 10px; left: 10px; z-index: 10001; background: rgba(0,0,0,0.5); padding: 10px; pointer-events: none; white-space: pre-line; }
    #fullscreenHint { color: rgba(255,255,255,0.5); font-size: 12px; position: absolute; bottom: 10px; width: 100%; text-align: center; pointer-events: none; z-index: 10001; }
    #projectorBlank { display: none; position: fixed; inset: 0; background: black; z-index: 10000; }
    
    #calibPanel { display: none; margin-top: 10px; padding: 12px; border-radius: 12px; border: 1px solid #eee; background: #fafafa; text-align: left; }
    #calibPanel h3 { margin: 0 0 10px 0; font-size: 14px; }
  </style>
</head>
<body>

  <div id="projectorView" ondblclick="toggleFullScreen()">
    <div id="projectorDebug">Initializing...</div>
    <img id="projectorImage" src="">
    <canvas id="projectorGridCanvas"></canvas>
    <div id="fullscreenHint">(Double-click screen for true fullscreen)</div>
  </div>

  <div id="projectorBlank"></div>

  <div id="mainInterface">
    <div id="lobbyScreen" class="screen active">
      <div class="card">
        <h2>ðŸŽ® Game Hub</h2>
        <input type="text" id="playerIdInput" placeholder="Enter Your Name / ID" />
        <div id="hostSection">
          <hr>
          <input type="text" id="gameName" placeholder="Room Name...">
          <button class="btn-primary" onclick="hostGame()">Host Game</button>
        </div>
        <div id="joinSection">
          <hr>
          <ul id="gameList"><li>Searching...</li></ul>
        </div>
      </div>
    </div>

    <div id="roomScreen" class="screen">
      <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <h2 id="roomTitle">Room</h2>
          <button style="width:auto; background:#ff4d4f; color:white; padding:5px 15px;" onclick="leaveGame()">EXIT</button>
        </div>
        <p>ID: <b id="roomCode">...</b></p>
        <a id="projectorLink" href="#" target="_blank" class="btn-link-projector">â›¶ Open Projector Tab</a>

        <hr>

        <button class="btn-camera" onclick="startCamera()">ðŸ“· Open Camera</button>
        <video id="videoPreview" autoplay playsinline></video>

        <button id="startBtn" class="btn-primary" style="display:none;" onclick="startSending()">â–¶ Start Auto-Send (30s)</button>
        <button id="stopBtn" class="btn-stop" onclick="stopSending()">â–  Stop Sending</button>

        <button id="calibBtn" class="btn-calib" style="margin-top:15px;" onclick="toggleCalibrationMode()">ðŸŽ¯ Calibration Mode: OFF</button>

        <div id="calibPanel">
          <h3>Calibration Tools</h3>
          <div class="row">
            <div>Grid Overlay</div>
            <button id="gridToggleBtn" class="toggleBtn off" onclick="toggleGrid()">OFF</button>
          </div>
          
          <div class="row">
            <div>Square Dimensions</div>
            <div class="dual-input">
                <div>
                    <span class="label">Width</span>
                    <input id="gridWidthInput" type="number" min="10" max="400" value="50" oninput="onGridInput()">
                </div>
                <div>
                    <span class="label">Height</span>
                    <input id="gridHeightInput" type="number" min="10" max="400" value="50" oninput="onGridInput()">
                </div>
            </div>
          </div>
          
          <div style="font-size:11px; opacity:0.8; line-height:1.35; background:#eef; padding:8px; border-radius:8px;">
            <b>Calibration:</b><br>
            Use Up/Down arrows on Width & Height until the projected square perfectly matches <b>1x1 inch</b> on your table.
          </div>
        </div>

        <div id="sendStatus"></div>
        <canvas id="canvas" style="display:none;"></canvas>
        <hr>
        <h3>Players:</h3>
        <ul id="playerList"></ul>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let currentRoomId = null;
    let cameraStream = null;
    let sendIntervalId = null;
    let myPlayerId = null;

    // Projector state
    let isProjectorMode = false;
    let projectorOwnerId = null;
    let projectorRoomId = null;
    
    // Calibration state
    let calibrationMode = false;
    let projectorViewMode = 'normal';

    const SEND_EVERY_MS = 30000;
    const STAGGER_JOIN_MS = 15000;
    const BLANK_BEFORE_MS = 220;
    const BLANK_AFTER_MS  = 80;

    // Grid Settings (NOW SEPARATE WIDTH/HEIGHT)
    let gridEnabled = false;
    let gridW = 50;
    let gridH = 50;
    
    // Projector Grid State
    let projGridEnabled = false;
    let projGridW = 50;
    let projGridH = 50;
    
    const GRID_COLS = 30; 
    const GRID_ROWS = 22;

    window.onload = function() {
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');

      if (mode === 'projector') {
        isProjectorMode = true;
        projectorRoomId = params.get('room');
        projectorOwnerId = params.get('owner');

        document.getElementById('mainInterface').style.display = 'none';
        document.getElementById('projectorView').style.display = 'flex';
        updateDebug(`Projector Active\nOwner: ${projectorOwnerId}\nMode: normal`);
        
        initProjectorGridCanvas();
        if (projectorRoomId && projectorOwnerId) {
          socket.emit('joinAsProjector', { roomId: projectorRoomId, ownerId: projectorOwnerId });
        }
        return;
      }

      if (mode === 'host') document.getElementById('joinSection').classList.add('hidden-section');
      else if (mode === 'join') document.getElementById('hostSection').classList.add('hidden-section');

      loadGridPrefs();
      syncGridPanelUI();
    };

    // --- UTILS ---
    function updateProjectorLink() {
      if (!currentRoomId || !myPlayerId) return;
      const url = `${window.location.origin}/?mode=projector&room=${encodeURIComponent(currentRoomId)}&owner=${encodeURIComponent(myPlayerId)}`;
      document.getElementById('projectorLink').href = url;
    }
    function updateDebug(msg) { const el = document.getElementById('projectorDebug'); if(el) el.innerText = msg; }
    function setStatus(msg) { const el = document.getElementById('sendStatus'); el.style.display = msg?'block':'none'; el.innerText=msg||''; }
    function toggleFullScreen() {
      const d=document; const e=d.documentElement;
      (d.fullscreenElement?d.exitFullscreen:e.requestFullscreen).call(d.fullscreenElement?d:e);
    }

    // --- PROJECTOR CONTROLS ---
    function setProjectorViewMode(mode) { if(currentRoomId) socket.emit('setProjectorViewMode', { roomId: currentRoomId, ownerId: myPlayerId, mode }); }
    
    function sendGridUpdate() { 
        if(!currentRoomId) return;
        socket.emit('setProjectorGrid', { 
            roomId: currentRoomId, 
            ownerId: myPlayerId, 
            enabled: !!gridEnabled, 
            width: parseInt(gridW),
            height: parseInt(gridH)
        }); 
    }
    
    function blankMyProjector(on) { if(currentRoomId) socket.emit('setProjectorBlank', { roomId: currentRoomId, ownerId: myPlayerId, blank: !!on }); }
    
    function toggleCalibrationMode() {
      calibrationMode = !calibrationMode;
      const btn = document.getElementById('calibBtn');
      const panel = document.getElementById('calibPanel');
      if (calibrationMode) {
        btn.classList.add('on'); btn.innerText = "ðŸŽ¯ Calibration Mode: ON"; panel.style.display = 'block';
        setStatus("Calibration ON: Projector shows YOUR camera feed.");
        setProjectorViewMode('calibrate'); 
        sendGridUpdate();
      } else {
        btn.classList.remove('on'); btn.innerText = "ðŸŽ¯ Calibration Mode: OFF"; panel.style.display = 'none';
        setStatus("Calibration OFF: Projector shows opponent.");
        setProjectorViewMode('normal'); 
        // Turn grid off when leaving calibration
        socket.emit('setProjectorGrid', { roomId: currentRoomId, ownerId: myPlayerId, enabled: false, width: gridW, height: gridH });
      }
    }

    // --- CAMERA & SENDING ---
    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true, audio: false }).then(s => {
        cameraStream = s;
        const v = document.getElementById('videoPreview'); v.srcObject = s; v.style.display = 'block';
        document.getElementById('startBtn').style.display = 'block';
        document.getElementById('calibBtn').style.display = 'block';
      }).catch(() => alert("Camera blocked!"));
    }

    function drawCenterDot(ctx, w, h) {
      const cx = w/2, cy = h/2;
      ctx.beginPath(); ctx.arc(cx, cy, 10, 0, Math.PI*2); ctx.strokeStyle="rgba(255,255,255,0.8)"; ctx.lineWidth=3; ctx.stroke();
      ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2); ctx.fillStyle="rgba(255,0,0,1)"; ctx.fill();
    }

    function captureAndSendFrame() {
      if (!cameraStream || !currentRoomId) return;
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 1280; canvas.height = 720;
      ctx.drawImage(document.getElementById('videoPreview'), 0, 0, 1280, 720);
      if (calibrationMode) drawCenterDot(ctx, 1280, 720);
      socket.emit('sendImage', { roomId: currentRoomId, image: canvas.toDataURL('image/jpeg', 0.6) });
      setStatus(`Sent snapshot at ${new Date().toLocaleTimeString()}`);
    }

    function captureAndSendWithBlank() {
      if (calibrationMode) { captureAndSendFrame(); return; }
      blankMyProjector(true);
      setTimeout(() => { captureAndSendFrame(); setTimeout(() => blankMyProjector(false), BLANK_AFTER_MS); }, BLANK_BEFORE_MS);
    }

    function startSending() {
      if (!cameraStream || !currentRoomId) return alert("Setup first!");
      if (sendIntervalId) return;
      const d = (new URLSearchParams(window.location.search).get('mode') === 'join') ? STAGGER_JOIN_MS : 0;
      setStatus(d ? `Starting in ${d/1000}s...` : "Starting...");
      setTimeout(() => {
        captureAndSendWithBlank();
        sendIntervalId = setInterval(captureAndSendWithBlank, SEND_EVERY_MS);
        document.getElementById('startBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = 'block';
      }, d);
    }

    function stopSending() {
      if (sendIntervalId) clearInterval(sendIntervalId);
      sendIntervalId = null;
      document.getElementById('stopBtn').style.display = 'none';
      document.getElementById('startBtn').style.display = 'block';
      setStatus("Stopped.");
      blankMyProjector(false);
    }

    // --- GRID UI ---
    function toggleGrid() { 
        gridEnabled = !gridEnabled; 
        syncGridPanelUI(); 
        if(calibrationMode) sendGridUpdate(); 
    }
    
    function onGridInput() { 
        const wVal = parseInt(document.getElementById('gridWidthInput').value);
        const hVal = parseInt(document.getElementById('gridHeightInput').value);
        
        if(wVal) gridW = Math.max(10, Math.min(400, wVal));
        if(hVal) gridH = Math.max(10, Math.min(400, hVal));
        
        saveGridPrefs();
        if(calibrationMode) sendGridUpdate(); 
    }
    
    function loadGridPrefs() { 
        gridEnabled=(localStorage.getItem("wg_grid_enabled")==="true"); 
        gridW=parseInt(localStorage.getItem("wg_grid_w")||"50"); 
        gridH=parseInt(localStorage.getItem("wg_grid_h")||"50"); 
    }
    
    function saveGridPrefs() {
        localStorage.setItem("wg_grid_enabled", gridEnabled); 
        localStorage.setItem("wg_grid_w", gridW);
        localStorage.setItem("wg_grid_h", gridH);
    }
    
    function syncGridPanelUI() {
      document.getElementById('gridToggleBtn').classList.toggle('off', !gridEnabled);
      document.getElementById('gridToggleBtn').innerText = gridEnabled ? "ON" : "OFF";
      document.getElementById('gridWidthInput').value = gridW;
      document.getElementById('gridHeightInput').value = gridH;
    }

    // --- PROJECTOR GRID DRAW ---
    function initProjectorGridCanvas() {
      if (!isProjectorMode) return;
      const c = document.getElementById('projectorGridCanvas');
      window.addEventListener('resize', () => { c.width=window.innerWidth; c.height=window.innerHeight; drawProjectorGrid(); });
      c.width=window.innerWidth; c.height=window.innerHeight;
    }

    function drawProjectorGrid() {
      if (!isProjectorMode) return;
      const c = document.getElementById('projectorGridCanvas');
      const ctx = c.getContext('2d');
      ctx.clearRect(0,0,c.width,c.height);
      
      if (!projGridEnabled) return;
      c.style.display='block';
      
      const totalGridWidth = GRID_COLS * projGridW;
      const totalGridHeight = GRID_ROWS * projGridH;
      
      const startX = (c.width - totalGridWidth) / 2;
      const startY = (c.height - totalGridHeight) / 2;
      
      ctx.lineWidth=1; ctx.strokeStyle="white"; ctx.globalAlpha=0.6;
      
      // Draw Verticals (use Width)
      for(let x=0; x<=GRID_COLS; x++) { 
          const xPos = startX + (x * projGridW);
          ctx.beginPath(); ctx.moveTo(xPos, startY); ctx.lineTo(xPos, startY + totalGridHeight); ctx.stroke(); 
      }
      
      // Draw Horizontals (use Height)
      for(let y=0; y<=GRID_ROWS; y++) { 
          const yPos = startY + (y * projGridH);
          ctx.beginPath(); ctx.moveTo(startX, yPos); ctx.lineTo(startX + totalGridWidth, yPos); ctx.stroke(); 
      }
      
      // Center Lines (Green)
      ctx.lineWidth=2; ctx.strokeStyle="#00ff00"; ctx.globalAlpha=0.8;
      const midX = startX + (GRID_COLS/2 * projGridW);
      ctx.beginPath(); ctx.moveTo(midX, startY); ctx.lineTo(midX, startY + totalGridHeight); ctx.stroke();
      const midY = startY + (GRID_ROWS/2 * projGridH);
      ctx.beginPath(); ctx.moveTo(startX, midY); ctx.lineTo(startX + totalGridWidth, midY); ctx.stroke();

      ctx.globalAlpha=1;
    }

    // --- SOCKET HANDLERS ---
    socket.on('errorMsg', alert);
    socket.on('projectorBlank', ({blank}) => { if(isProjectorMode) document.getElementById('projectorBlank').style.display = blank?'block':'none'; });
    socket.on('projectorViewMode', ({mode}) => { if(isProjectorMode) { projectorViewMode=mode; updateDebug(`Projector Active\nOwner: ${projectorOwnerId}\nMode: ${mode}`); } });
    
    // UPDATED SOCKET HANDLER FOR 2 DIMENSIONS
    socket.on('projectorGrid', ({enabled, width, height}) => { 
        if(isProjectorMode) { 
            projGridEnabled=enabled; 
            projGridW = width || 50;
            projGridH = height || 50;
            drawProjectorGrid(); 
            document.getElementById('projectorGridCanvas').style.display = enabled?'block':'none'; 
        } 
    });
    
    socket.on('receiveImage', ({image, senderId}) => {
      if (!isProjectorMode) return;
      if (projectorViewMode === 'normal' && senderId === projectorOwnerId) return;
      if (projectorViewMode === 'calibrate' && senderId !== projectorOwnerId) return;
      document.getElementById('projectorImage').src = image;
      document.getElementById('fullscreenHint').style.display = 'none';
    });
    
    // --- STANDARD GAME LOGIC ---
    function getPlayerId() { return document.getElementById('playerIdInput').value.trim(); }
    function hostGame() { const n = document.getElementById('gameName').value.trim(); myPlayerId = getPlayerId(); if(n && myPlayerId) socket.emit('hostGame', {name:n, playerId:myPlayerId}); }
    function joinGame(id) { myPlayerId = getPlayerId(); if(myPlayerId) socket.emit('joinGame', {roomId:id, playerId:myPlayerId}); }
    function leaveGame() { if(currentRoomId) socket.emit('leaveGame', currentRoomId); }
    socket.on('updateGameList', (g) => {
      const l = document.getElementById('gameList'); l.innerHTML = '';
      Object.values(g).forEach(r => l.innerHTML += `<li><b>${r.name}</b> <button class="btn-primary" style="width:auto; padding:5px;" onclick="joinGame('${r.id}')">Join</button></li>`);
    });
    socket.on('joinedRoom', (r) => {
      currentRoomId = r.id;
      document.getElementById('lobbyScreen').classList.remove('active');
      document.getElementById('roomScreen').classList.add('active');
      document.getElementById('roomTitle').innerText = r.name;
      document.getElementById('roomCode').innerText = r.id;
      document.getElementById('playerList').innerHTML = r.players.map(p => `<li>ðŸ‘¤ ${p}</li>`).join('');
      updateProjectorLink();
      
      // Reset Calibration
      calibrationMode = false;
      document.getElementById('calibBtn').classList.remove('on');
      document.getElementById('calibPanel').style.display = 'none';
      setProjectorViewMode('normal');
    });
    socket.on('playerUpdate', (p) => document.getElementById('playerList').innerHTML = p.map(u => `<li>ðŸ‘¤ ${u}</li>`).join(''));
    socket.on('backToLobby', () => {
      currentRoomId = null; stopSending();
      document.getElementById('roomScreen').classList.remove('active');
      document.getElementById('lobbyScreen').classList.add('active');
      if (cameraStream) cameraStream.getTracks().forEach(t => t.stop()); cameraStream = null;
      projGridEnabled=false;
    });
  </script>
</body>
</html>
